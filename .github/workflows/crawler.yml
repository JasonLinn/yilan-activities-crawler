# .github/workflows/crawler.yml
name: å®œè˜­æ´»å‹•çˆ¬èŸ²

on:
  schedule:
    # æ¯å¤© UTC 01:00 å’Œ 13:00 åŸ·è¡Œ (å°ç£æ™‚é–“ 09:00 å’Œ 21:00)
    - cron: '0 1,13 * * *'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      debug:
        description: 'å•Ÿç”¨é™¤éŒ¯æ¨¡å¼'
        type: boolean
        default: false

jobs:
  crawl-activities:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # å…è¨±æ¨é€åˆ° repository
    
    steps:
      - name: ğŸ“¥ å–å¾—ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£ç›¸ä¾å¥—ä»¶
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ•·ï¸ åŸ·è¡Œçˆ¬èŸ²
        run: |
          python crawler.py
        env:
          PYTHONIOENCODING: utf-8
        timeout-minutes: 15
      
      - name: ğŸ“Š é¡¯ç¤ºçˆ¬å–çµæœ
        run: |
          echo "=== çˆ¬å–çµæœ ==="
          if [ -f "data/latest_activities.json" ]; then
            echo "âœ… æˆåŠŸçˆ¬å–è³‡æ–™"
            python -c "import json; data = json.load(open('data/latest_activities.json', 'r', encoding='utf-8')); print(f'ğŸ“… æ›´æ–°æ™‚é–“: {data[\"update_time\"]}'); print(f'ğŸ“ æ´»å‹•æ•¸é‡: {data[\"total_count\"]} ç­†')"
          else
            echo "âŒ æœªæ‰¾åˆ°çˆ¬å–çµæœ"
          fi
      
      - name: ğŸ’¾ æäº¤è®Šæ›´
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add -A
          
          if git diff --staged --quiet; then
            echo "ğŸ“„ ç„¡æ–°è³‡æ–™ï¼Œè·³éæäº¤"
          else
            git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°æ´»å‹•è³‡æ–™ - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… è³‡æ–™å·²æ›´æ–°ä¸¦æ¨é€"
          fi
      
      - name: ğŸ“ˆ ä¸Šå‚³çˆ¬å–çµ±è¨ˆ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crawl-logs-${{ github.run_number }}
          path: |
            data/
            README.md
          retention-days: 7
      
      - name: ğŸ“Š é¡¯ç¤ºçˆ¬å–ç‹€æ…‹
        if: always()
        run: |
          echo "=== çˆ¬å–ç‹€æ…‹å ±å‘Š ==="
          if [ -f "data/crawler_status.json" ]; then
            echo "ğŸ“‹ ç‹€æ…‹æª”æ¡ˆå­˜åœ¨ï¼Œé¡¯ç¤ºå…§å®¹:"
            cat data/crawler_status.json
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç‹€æ…‹æª”æ¡ˆ"
          fi

  # å¥åº·æª¢æŸ¥ä»»å‹™
  health-check:
    needs: crawl-activities
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“‹ æª¢æŸ¥çˆ¬èŸ²ç‹€æ…‹
        run: |
          if [ "${{ needs.crawl-activities.result }}" == "success" ]; then
            echo "âœ… çˆ¬èŸ²åŸ·è¡ŒæˆåŠŸ"
          else
            echo "âŒ çˆ¬èŸ²åŸ·è¡Œå¤±æ•—"
            echo "è«‹æª¢æŸ¥æ—¥èªŒæ‰¾å‡ºå•é¡ŒåŸå› "
            exit 1
          fi